#!/bin/bash
set -euo pipefail

# Load environment variables from .env if present
set -a
if [ -f ./.env ]; then
  . ./.env
fi
set +a

# Validate required variables
: "${DISCORD_APP_ID:?Set DISCORD_APP_ID in environment or .env}"
: "${DISCORD_GUILD_ID:?Set DISCORD_GUILD_ID in environment or .env}"
: "${DISCORD_BOT_TOKEN:?Set DISCORD_BOT_TOKEN in environment or .env}"

curl -X PUT "https://discord.com/api/v10/applications/$DISCORD_APP_ID/guilds/$DISCORD_GUILD_ID/commands" \
  -H "Authorization: Bot $DISCORD_BOT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '[
    {
      "name": "study",
      "description": "Study bot commands",
      "type": 1,
      "dm_permission": false,
      "options": [
        {
          "type": 1,
          "name": "log",
          "description": "해당 주차(스레드)에 체크인 링크를 기록",
          "options": [
            { "type": 3, "name": "link", "description": "디스코드 메시지 링크", "required": true }
          ]
        },
        { "type": 1, "name": "dashboard", "description": "통합 대시보드" },
        {
          "type": 2,
          "name": "forum",
          "description": "스터디 포럼 관리",
          "options": [
            { "type": 1, "name": "register", "description": "현재 포럼 채널 등록" },
            { "type": 1, "name": "list", "description": "등록된 포럼 목록" }
          ]
        }
      ]
    }
  ]'